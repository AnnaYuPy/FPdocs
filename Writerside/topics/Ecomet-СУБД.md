# Ecomet (СУБД)

Ecomet - это СУБД для real-time приложений.

Ecomet предлагает встроенную модель управления правами пользователей и поддержку защищенных подключений через Secure WebSocket, что позволяет обеспечить безопасную работу с данными из браузера с использованием JavaScript. Для упрощения задач интеграции в Ecomet реализованы библиотеки на языке JavaScript.

## Настройка и работа с базой данных

- Подключение библиотеки для работы с СУБД:

```bash
<script src = "lib/js/ecomet.js" type = "text/javascript"></script>
```

- Работа с API СУБД:

*Создание нового объекта:*

``` bash
// Вывод ошибок
OnError = function(ErrText){alert(ErrText);};

// Создание объекта
ecomet.create_object({
    ".name": "my_object",                           // имя объекта
    ".folder": "/root/test_folder",                 // папка
    ".pattern": "/root/.patterns/test_pattern",     // шаблон объекта
    "field1": "value1",                             // тестовое поле
    "field2": 12.34,                                // поле float
}, OnError);
```

*Редактирование объекта:*

``` bash
// Редактирование объекта
ecomet.edit_object("/root/test_folder/my_object", {
    "field1": "new value",      // новый текст 
    "field2": 34.12,            // новое число
}, OnError);
```

*Удаление объекта:*

```bash
// Удаление объекта
ecomet.delete_object("/root/test_folder/my_object", OnError);
```

*Простой запрос:*

```bash 
// Поиск объектов
ecomet.find(
    "GET .name, field2 WHERE field1=’new value’ ",  // Запрос
    function(Data){ Result = Data; },          // Получение результата
    OnError);

// Результат (Result)
{ "total": 1, "set": [                         // Найдено объектов
    { "oid": "{58,3}",                         // идентификатор объекта
        "fileds": {                            // Запрошенные поля:
        ".name": "my_object",                  //   - имя объекта
        "field2": 34.12 }}]                    //   - поле “field2”
}
```

*Подписка (данные в реальном времени):*

```bash 
// Динамическая подписка
ecomet.subscribe(
    "GET .name, field2 WHERE field1=’new value’ ",          // Запрос
    OnCreate,                       // Добавление объекта (в выборку!)
    OnEdit,                         // Редактирование объекта
    OnDelete,                       // Удаление объекта (из выборки!)
    OnError);

// Реакция на добавление объекта в выборку
OnCreate = function(Data){ Result=Data; }

// Реакция на редактирование объекта
OnEdit = function(Data){ Result=Data; }

// Реакция на удаление объекта
OnDelete = function(Data){ Result=Data; }

// Result
{“oid”: “{58,3}”,                   // идентификатор объекта
“fields”: {                         // Запрошенные поля:
    “.name”: “my_object”,           // - имя объекта
    “field2”: 34.12 }}              // - поле “field2”
```

> **ВНИМАНИЕ!**
>
> При редактировании объекта Result содержит только измененные поля, при удалении - поля пусты.
>
{style="note"}

## Скорость

На больших объемах данных наиболее ресурсоемкими являются операции поиска, группировки и сортировки.

Ecomet для эффективного решения этих проблем использует индексы и оптимизированные для них алгоритмы в сочетании с технологией распределенного поиска:

- <b>Послойная индексация с алгоритмом нисходящего поиска </b> повышает производительность более чем в 20 раз;
  ![](Ecomet.1.png){width=300 thumbnail="true"}{border-effect=line}
- <b>Подписка на поисковой запрос</b> позволяет получать данные в режиме реального времени;
- <b>Технология кэширования с возможностью явного определения способа хранения до уровня отдельных полей объекта</b> минимизирует количество обращений к внешней памяти.

## Управление правами пользователей

Механизмы разграничения прав пользователей в СУБД Ecomet схожи с системой прав доступа в ОС Linux:

- каждое подключение к базе требует авторизации; каждый процесс,обслуживающий подключение, работает в контексте конкретного пользователя;
- пользователи объединяются в группы;
- каждый пользователь может быть участником нескольких групп;
- каждый объект базы данных имеет системные поля:
    - ```.readgroups``` - список групп, имеющих право на чтение объекта;
    - ```.writegroups``` - список групп, имеющих право на изменение объекта;
- каждый объект при создании наследует конфигурацию прав из папки, в которой он создается, если права не определены явно.

![](Ecomet.2.png){width=400 thumbnail="true"}{border-effect=line}

## Логическая организация данных

- ![](Aspose.Words.7ab25b03-c1da-422c-8229-366aad17399d.024.jpeg)Данные представлены в виде*объектов*. Полезная информация хранится в *полях* объектов.
- Состав и тип допустимых полей объекта определяется *шаблоном*объекта. Шаблон - аналог определения таблицы в реляционных СУБД (*схема*).
- Шаблоны объектов поддерживают *наследование*. Наследник получает наборполейродительскогошаблона,атакженаследуетего*поведение*.
- Поведение объектов определяется подключаемыми программными модулями.
- Цепочка наследования каждого шаблона всегда заканчивается шаблоном .object, который определяет набор системных полей объекта,атакжеопределяетегоповедениекакобъектабазыданных.
- Объекты хранятся в *папках*, аналогично файлам в файловой системе. Каждая папка - объект, который также расположен в одной из папок и имеет поля.

![ref1]![ref2]Схемахранения.Структура


Разные поля одного объекта могут принадлежать разным хранилищам. Тип хранилища определяетсявшаблонеобъектаотдельнодлякаждогополя(свойствоstorage).


Хранилища состоят из физических фрагментов. Фрагменты группируются в спейсы. Спейсы распределяются по узлам. Каждый space может иметь копии на нескольких узлах. Конфигурирование выполняется без останова узлов. Папка “/root/.storage”.

![ref1]![ref2]Схемахранения.Структура

![](Aspose.Words.7ab25b03-c1da-422c-8229-366aad17399d.025.png)

Шаблоныобъектов


![ref1]![ref2]Шаблоны являются служебными объектами, которые определяют структуру, способ хранения и поведение хранимых в базе объектов. Объект шаблона может быть создан, отредактирован или удален таким же способом как и любой другой объект.

- Объектышаблоновхранятсявпапке“/root/.patterns/”.
- КакидругиеобъектыБД,шаблоныимеютсхему,котораяопределена шаблоном .pattern.
- Шаблон.patternявляетсянаследникомшаблона.folder.Это означает,	что	объект	шаблона	является	*папкой*.	Папка содержит объекты - *поля*.
- Объектшаблонаопределяет:
    - *storage*-типхранилища(ram,ramdisc,disc),
    - *parent\_pattern*-родительскийшаблон,
    - *handler\_module*-программныймодуль,определяющий поведение объектов данного шаблона.



![](Aspose.Words.7ab25b03-c1da-422c-8229-366aad17399d.026.jpeg)

***O***-поля,унаследованныеиз.object ***F***-поля,унаследованныеиз.folder ***P*** - поля, определенные в .pattern

![ref1]![ref2]Шаблоныобъектов.Поля

Поля - служебные объекты, хранящиеся в папках шаблонов. Объекты полей выполняют функции аналогичные определениям столбцов таблицы в реляционных СУБД и имеют следующие свойства:

- *.name*- имяполя
- *type*-типполя,(string,integer,binaryит.д.)
- *subtype*-типэлементовмассивадляполейтипа*list*
- *index*-списокформируемыхнаполетиповиндексов
- *storage* - тип хранилища: ram, ramdisc, disc. Поля одного объекта могут иметь разный тип хранения. Формируемые на поле индексы имеют одинаковый с полем тип хранения.
- *required*-флаг-обязательноеполе
- *default\_value*-значениепоумолчанию
- *autoincrement*- флаг - значение поля формируется автоматически. Гарантируется уникальность значения в рамках множества объектов принадлежащих шаблону

![ref1]![ref2]Типыиндексов

Индексы представляют собой оптимизированные под поисковые алгоритмы структуры данных. Использование индексов позволяет значительно повысить производительность поисковых запросов. Ecomet поддерживает следующие типы индексов:

- simple - 2-х уровневый*сжатый битовый*индекс. Тип используется*алгоритмом нисходящего поиска*\*.Сжатие*пузырьковым алгоритмом*\*решает проблему разреженности битового индекса при его высокой селективности.
- n-gram -тип представляет собой адаптацию simple индекса для использования алгоритмом полнотекстового поиска по n-граммам\*.
- bitslice - тип служит для оптимизации агрегирующих операций (sum, average) по числовым полям\*\*,
- sorted - разновидность b-tree индекса. В сочетании с simple индексом используется *алгоритмом трапецеидального поиска*\*для оптимизации поиска по интервалу значений и/или сортировки вывода результатов поиска \*\*.

\*-*инновационныерешения,*\*\*-*неподдержановтекущейверсии,этапреализации*

![ref1]![ref2]Поведениеобъектов

- Объекты хранимые в базе могут иметь определяемую пользователем*реакцию*на их создание,изменениеиудаление- *поведение*.
- Реакция на события определяется в подключаемых программных модулях. Модули должны быть реализованы на языке*Erlang*и обязательно содержать определение внешних callback-функций: on\_create/1, on\_edit/1, on\_delete/1. Модуль поведения для объектов задается через поле handler\_module в их шаблоне.
- На вход callback-функций подается*проект объекта*, из которого можно получить информацию о текущем состоянии объекта и вносимых в него изменениях.
- Код модуля исполняется процессом, обслуживающим текущее подключение к базе, и имеет контекст авторизованного пользователя. Callback всегда выполняется в рамках транзакции. В случае возврата ошибки изменение не будет применено.
- Модуль поведения может взаимодействовать с СУБД Ecomet как с Erlang/OTP приложением через нативный программный интерфейс. Имеется возможность работы с другими доступными библиотеками и приложениями Erlang.
- Если родительский шаблон также определяет некоторое поведение для объекта, то оно *наследуется*. Это означает, что callback-функции родителя также будут выполнены. Порядоквызова-*отпотомкакродителю*.

![ref1]![ref2]Схемахранения.Типыхранилищ

Физическиданныехранятсяв*хранилищах*.Имеютсяследующиетипыхранилищ:

- *ram*	-	оперативная	память.	Данные	хранятся	только	в	памяти.	Хранилище характеризуетсявысокойскоростьюдоступакданным,нопредъявляеттребованияк объемудоступнойоперативнойпамяти.Прирестартесистемыданныемогутбыть утеряны,вслучаеотсутствиякопиинадругихузлах(кластер).
- *ramdisc* - оперативная память и жесткий диск. Данные хранятся в памяти, а также имеется копия на диске. На диске ведется секвентальный лог изменений, который периодически сбрасывается в дамп. Хранилище, как и ram, имеет высокую скорость доступакданнымитребованиякобъемупамяти.Восстановлениеданныхприрестарте, независимо от наличия копий на других узлах.
- *disc*-жесткийнакопитель.Данныехранятсятольконадиске.Скоростьчтениянижечем ram или ramdisc, но хранилище позволяет хранить большие объемы информации, не умещающиеся в оперативной памяти. Производительность операций:
    - Записьведетсявпромежуточныйramdiscбуфер,которыйприпереполнении

      периодически сбрасывает излишки на диск (асинхронно). Скорость записи равна ramdisc.

    - Результатыоперацийначтениесохраняютсяв*кэш*.Скоростьобращенияк

      наиболеевостребованнымданнымравнаram.

![ref1]![ref2]Мульти-кластер.Доменыданных

В типовом сценарии Ecomet - распределенная система, состоящая из одного или более *кластеров*. Каждый кластер включает минимум один*узел*. Подключаясь к одному из узлов системы, пользователь получает доступ ко всему информационному фонду. Доступ к данным ограничен только правами пользователя.

Предполагается, что каналы связи между кластерами имеют более низкую пропускную способность, чем между узлами кластера. Это может приводить к задержкам, если пользователь работает с данными, которые физически хранятся на другом кластере. Для решения проблемы введено понятие*домена*данных. Домен позволяет сгруппировать логически тесно связанные данные в рамках одного кластера.

Каждый домен имеет собственный набор хранилищ ram, ramdisc, disc и привязан к конкретномукластеру.Хранилищадоменараспределеныпоузламкластера.

Логически домен представляет собой*папку*(объект Ecomet). Объекты создаваемые в этой папке физически хранятся в хранилищах этого домена.

Если запрос пользователя охватывает данные из удаленных доменов, то задача разбивается на домены и подзадачи делегируются соответствующим кластерам. Кластер, работая с локальными хранилищами, эффективно выполняет работу и отправляет готовый результат “узлу-заказчику”.Заказчиквыполняетсверткуиотправляетответклиенту(MapReduce).

Единыйинформационныйфонд

- ![](Aspose.Words.7ab25b03-c1da-422c-8229-366aad17399d.027.png)Независимо от точки подключения пользователь работает с одними и теми же всегда актуальными данными.
- Отсутствуетединаяточкаотказа.Привыходе из строя узла нагрузка распределяется между рабочимиузлами.Максимальноеколичество рабочих узлов - 65536.
- Пользователь имеет дело только с логической организацией данных, их реальное физическое размещение остается за кадром.
- Работа с данными максимально проста и прозрачна.
- Добавление/удаление узлов, доменов, конфигурирование хранилищ выполняется “на ходу”
