# Faceplate Prophet

## Настройка сервиса Моделирование

В файле fp_modeling в 731 строке нужно изменить путь следующим образом:
```
%Cmd=code:priv_dir(fp)++"/models/" ++ Model ++ "/" ++ Model,
Cmd = "/home/fp/.ssh/faceplate/apps/fp/priv/models/prophet/prophet.py",
```

Далее нужно:

1. создать файл faceplate/apps/fp/priv/models/prophet/prophet.py, где prophet.py это пример файла, который принимает моделирование;
2. json-файл должен принимать metadata, prediction, anomalies(может быть пустым).

### Основные определения:

Целевой архив - данные, которые читает модель.

Конечный архив - архив куда будет выгружаться архив.

Шаблон аларма - если придет поле аномалии, то формируем сообщение на основе этого шаблона

Регрессоры - дополнительный архив исторических данных, который можно отправить с целевым архивом. 
Например, нагрузка потребления электроэнергии это целевой архив, а температура в те же дни это регрессор. (Не обязательный параметр)

Время отсчета - время начала моделирования.

Глубина истории - с какого времени хотим видеть данные. Допустим если время отсчета 13:30, а глубина истории 30 минут, то график мы видим с 13:00.

Дискретность - частота.

Прогноз - прогнозируемое время. Допустим если прогноз 10 минут, то мы получим данные до 13:40.

Метаданные - произвольный json который пользователь может разрабатывать.

Запуск - триггер.
       
Если будет аномалия, то будет нарисована точка.

```
JSON FILE
#!/usr/bin/python3

import json
import os
JSON = "{
   "metadata": {
      "containerId": "16354ed4eeaa5eb42169c153b731a56eea09dc450476ef101c57090fcb3afe7d",
      "point": "shym-2",
      "start_time": "2021-10-20 10:38:37.518264",
   "finish_time": "2021-10-20 10:39:22.661520"
   },
   "prediction": [
      26.440550333303296,
      27.934360447781003,
      21.55088396636851
   ]
}"
JSON = JSON.replace("\n", "") + "\n"
data = os.read(3, 10000)

print('pytho_script: '+ str(json.loads(data)))
os.write(4, bytes(JSON, "utf-8"))

#print(JSON)
#obj = json.loads(JSON)
#print(obj)
```

Вывод в консоли:
```
(fp@master.fp)1> 15:32:03.276 [info] fp_modeling:733 Command "/home/fp/.ssh/faceplate/apps/fp/priv/models/prophet/prophet.py"
15:32:03.339 [info] fp_modeling:770 pred points 10 history length 30 future length 10
pytho_script: {'future': [[1681975860000], [1681975920000], [1681975980000], [1681976040000], [1681976100000], [1681976160000], [1681976220000], [1681976280000], [1681976340000], [1681976400000]], 'history': [[1681974060000, 4.53255], [1681974120000, 5.68345], [1681974180000, 5.2502], [1681974240000, 4.88345], [1681974300000, 5.633233333333333], [1681974360000, 5.050516666666667], [1681974420000, 5.666566666666666], [1681974480000, 5.78315], [1681974540000, 5.232583333333333], [1681974600000, 5.600216666666666], [1681974660000, 5.366483333333333], [1681974720000, 5.36685], [1681974780000, 5.833916666666667], [1681974840000, 5.283183333333334], [1681974900000, 5.983333333333333], [1681974960000, 5.7668333333333335], [1681975020000, 5.466966666666667], [1681975080000, 6.3], [1681975140000, 5.18335], [1681975200000, 5.433416666666667], [1681975260000, 5.316566666666667], [1681975320000, 5.366733333333333], [1681975380000, 5.73315], [1681975440000, 6.266666666666667], [1681975500000, 5.49965], [1681975560000, 5.466933333333333], [1681975620000, 5.3326], [1681975680000, 5.600366666666667], [1681975740000, 5.000116666666667], [1681975800000, 5.533766666666667]], 'history_future': [[1681975860000, 4.732983333333333], [1681975920000, 5.2665], [1681975980000, 5.03305], [1681976040000, 5.216733333333333], [1681976100000, 5.883366666666666], [1681976160000, 6.1002], [1681976220000, 5.650016666666667], [1681976280000, 5.6997], [1681976340000, 5.516466666666667], [1681976400000, 5.400483333333334]], 'metadata': {'settings': {'changepoint_prior_scale': 30, 'daily_seasonality': False, 'growth': 'linear', 'interval_width': 0.98, 'seasonality': [{'fourier_order': 5, 'name': 'hour', 'period': 0.0417}], 'seasonality_prior_scale': 35, 'weekly_seasonality': False, 'yearly_seasonality': False}}}
15:32:03.341 [info] fp_modeling:781 received result #{<<"metadata">> => #{<<"containerId">> => <<"16354ed4eeaa5eb42169c153b731a56eea09dc450476ef101c57090fcb3afe7d">>,<<"finish_time">> => <<"2021-10-20 10:39:22.661520">>,<<"point">> => <<"shym-2">>,<<"start_time">> => <<"2021-10-20 10:38:37.518264">>},<<"prediction">> => [26.440550333303296,27.934360447781003,21.55088396636851]}
```