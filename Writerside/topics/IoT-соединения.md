# IoT-соединения

## Что такое IoT? {id = "iot"}
IoT расшифровывается как "Интернет вещей" (Internet of Things). Это концепция, в основе которой лежит идея о сети взаимосвязанных устройств, способных собирать и обмениваться данными через Интернет без прямого участия человека. Устройства IoT могут быть чем угодно: от умных домашних устройств, таких как термостаты и умные замки, до промышленного оборудования, автомобилей и даже медицинских приборов.

Основная идея IoT заключается в том, чтобы сделать устройства "умными", т.е. снабдить их сенсорами, актюаторами и возможностью подключения к интернету, что позволяет им собирать данные о своем окружении, взаимодействовать друг с другом и с внешними системами, а также выполнять различные задачи с минимальной или нулевой человеческой интервенцией.

## Почему используются IoT-оединения {id = "why"}
IoT-соединения имеют ряд преимуществ и используются для:
1.	Расширения возможностей мониторинга и управления: Подключение IoT-устройств позволяет расширить область мониторинга и управления промышленными процессами. Данные, собранные с помощью IoT-устройств, могут дополнять информацию, собираемую традиционными средствами, обогащая ее и позволяя получать более полное представление о состоянии системы.
2.	Увеличения доступности данных: IoT-соединения могут обеспечить доступ к данным из удаленных местоположений, где установка традиционной инфраструктуры SCADA может быть сложной или дорогостоящей. Это позволяет мониторить и управлять процессами на расстоянии, что особенно важно для компаний с распределенными объектами.
3.	Улучшения гибкости и масштабируемости: Использование IoT-соединений позволяет создавать более гибкие и масштабируемые системы мониторинга и управления. Устройства IoT могут быть легко добавлены или удалены из сети, а сама сеть может быть масштабирована по мере необходимости, обеспечивая возможность адаптации к изменяющимся требованиям бизнеса.
4.	Использования современных технологий и аналитики: IoT-устройства могут предоставлять данные в реальном времени, что позволяет использовать современные технологии аналитики для обработки и анализа этих данных. Это может включать в себя применение методов машинного обучения для выявления аномалий или оптимизации процессов на основе собранных данных.
5.	Снижения затрат на обслуживание и эксплуатацию: Использование IoT-соединений может снизить затраты на обслуживание и эксплуатацию системы за счет возможности удаленного мониторинга и управления процессами. Это может включать в себя раннее обнаружение проблем и предотвращение аварийных ситуаций, что помогает сократить расходы на ремонт и замену оборудования.

## Настройка IoT-соединений в FACEPLATE {id = "settings"}

Для настройки IoT-соединения в FACEPLATE необходимо выбрать один из протоколов (HTTP, MQTT, WebSocket), согласно которому будет установлено подключение и будут передаваться данные.

Для настройки обмена данными по выбранному протоколу между FACEPLATE и другими информационными системами  используются следующие компоненты:
●	тип подключения (connection);
●	тип привязки (binding);
●	реакция (reaction) или направление передачи данных: источник данных (source) или действия (actions).

Структуру и общий принцип работы IoT-соединений в FACEPLATE можно представить следующим образом:

![](IoT1.png){width=700 thumbnail="true"}{border-effect=line}

Тип подключения позволяет установить базовые параметры соединения (название, протокол, период между попытками установки соединения и т.д.), включить или выключить соединение.

Соединение может включать в себя одну или несколько привязок. У привязки есть общие параметры, такие как название и тип привязки. Тип привязки определяет способ взаимодействия между системами:

1.	SEND - система только отправляет данные во внешнюю систему. Содержит только раздел Output.
2.	SEND_RECEIVE - система отправляет запрос во внешнюю система и ожидает, что внешняя система вернет какие-либо данные в ответ. Содержит раздел Output, за которым следует раздел Input.
3.	RECEIVE - система ожидает данные из внешней системы и не отправляет ничего в ответ. Содержит только раздел Input.
4.	RECEIVE_SEND - система ожидает данные из внешней системы и формирует ответ. Содержит раздел Input, за которым следует раздел Output.

Некоторые протоколы позволяют использовать все 4 типа привязок в одном соединении, другие позволяют использовать только определенные типы привязок в зависимости от настроек соединения.
В общем случае, в разделах Input/Output определяется json-шаблон, по которому будут формироваться данные для приема/передачи из/в удаленную систему. Так же в этом разделе может быть определен ряд параметров, используемых при передачи данных. Набор данных параметров зависит от протокола соединения.
Для первых двух типов привязок в разделе Output помимо json-шаблона и параметров, специфичных для протокола, так же определяется событие инициирующее обмен данными.

## Как создать IoT-подключение {id = "how to create"}
Настройка IoT-соединения выполняется во вкладке "Общий вид", расположенной в меню навигации FACEPLATE Studio. На панели управления следует нажать на кнопку Создать, после чего появится окно:

![](IoT2.png){width=700 thumbnail="true"}{border-effect=line}

### Настройка HTTP-подключения {id="HTTP-connection"}

Подключения данного типа позволяют FACEPLATE обмениваться данными с удаленными системами посредством протокола HTTP. Задача, которая традиционно решается с помощью протокола HTTP - это обмен данными между пользовательским приложением (например, веб-браузер), осуществляющим доступ к веб-ресурсам (веб-сервер).

•	HTTP (Hypertext Transfer Protocol) - это протокол, который используется для передачи данных в форме гипертекстовых документов (например, веб-страниц) между клиентом и сервером в сети Интернет.
•	HTTP предполагает однонаправленную связь, где клиент отправляет запрос на сервер, а сервер отвечает на этот запрос, обычно отправляя запрошенные данные.
•	Каждое HTTP-сообщение состоит из запроса и ответа. Запрос отправляется клиентом на сервер, и сервер отвечает на этот запрос соответствующим ответом.
•	HTTP не сохраняет состояние между запросами. Каждый запрос рассматривается отдельно, и сервер не запоминает предыдущие запросы от одного и того же клиента, если не используются механизмы сеансов или куки.
•	HTTP-запросы и ответы обычно представлены в виде текстовых сообщений, состоящих из заголовков и тела сообщения.
•	HTTP поддерживает различные методы запроса, такие как GET (получить), POST (отправить), PUT (обновить), DELETE (удалить) и другие, которые определяют действие, выполняемое сервером.

### Настройка привязки серверного HTTP соединения {id="HTTP-server"}
При создании подключения типа IOT_HTTP_SERVER появляется следующая форма:

![](IoT4.png){width=700 thumbnail="true"}{border-effect=line}

Если был выбран тип HTTP соединения Server, то привязка может быть типа RECEIVE-ONLY или типа RECEIVE-SEND. Настройка привязки серверного HTTP соединения выполняется в следующей форме:
Для серверного соединения может быть активирована опция "Аутентификация по сертификату". После активации этой опции появится возможность выбора сертификата, с которым будет сверятся сертификат, полученный в клиентском запросе. В данном случае, аутентификация будет происходить в два этапа.
На первом этапе сервер проверит, является ли полученный от клиента сертификат доверенным (соответствует ли издатель клиентского сертификата издателю сертификата сервера, сертификат сервера указывается в настройках системы). При этом Common Name (CN) у пользовательского сертификата не должно совпадать с CN серверного сертификата.

Если на этом этапе возникают ошибки при попытке соединения с сервером, для тестирования соединения можно воспользоваться утилитой командной строки curl:

curl -k -vvvv --cert файл_сертификата.cert.pem --key файл_ключа.key.pem --cacert файл_корневого_сертификата.cert.pem "https://путь к сервису".

Если первый этап пройден, на втором этапе клиентский сертификат сверяется с сертификатом, указанным в поле выбора сертификата настроек HTTP соединения. Если сертификат в клиентском запросе отсутствует или не соответствует заданному, считается, что клиент не прошел процедуру аутентификации.

Непосредственно к HTTP протоколу относятся следующие поля:

1) Путь к настраиваемому сервису (path). Пример полного пути к сервису, настраиваемого в сторонней системе:
   localhost:9000/rest/<connection name>/<binding name>?town=London & appid=4459999
   localhost:9000/rest - имя хоста, порт на котором запущен faceplate,  rest - префикс для всех rest запросов
   http_server_connection_name - имя соединения
   http_server_binding_name - имя привязки
   http_path - дополнительный путь, настраивается в поле "путь" (path) привязки.
   town=London & appid=4459999 - строка запроса

2) Метод запроса - GET или POST.

3) Заголовки HTTP - настройки заголовков HTTP. Каждый входящий запрос проверяется на соответствие заголовка установленному шаблону.

4) URL запрос - настройки параметров запроса. Каждый входящий запрос проверяется на соответствие параметров запроса установленным шаблонам.

### Настройка привязки клиентского HTTP соединения {id = "HTTP-client"}
Если был выбран тип HTTP соединения Client, то привязка может быть типа SEND-ONLY или типа SEND-RECEIVE. Настройка привязки клиентского HTTP соединения выполняется в следующей форме:

Непосредственно к HTTP протоколу относятся следующие поля:

1) Путь (path) - составляющая полного URI запроса, не включающая host (из настроек http соединения) и параметры запроса.
2) Метод запроса - GET или POST.
3) HTTP заголовки - настройки заголовков HTTP. Можно добавить несколько заголовков HTTP. Слева - заголовок, справа - значение заголовка. Значением заголовка может быть текстовое значение либо строка-шаблон, содержащая переменные. Переменные задаются в формате ${имя_переменной}. Переменные позволяют формировать заголовки динамически.
4) URL запрос - настройки параметров запроса. Можно добавить несколько параметров. Слева - заголовок, справа - значение параметра. Значением параметра может быть текстовое значение либо строка-шаблон, содержащая переменные. Переменные позволяют формировать динамические GET-запросы.

## Режим трансформации
### Json-шаблоны {id = "json-pattern"}

JSON (JavaScript Object Notation) - это легкий формат обмена данными, который широко используется для передачи структурированной информации между приложениями. В контексте IIoT-платформы, JSON-шаблоны играют ключевую роль в обмене данными с внешними системами. Вот как их создавать, использовать и примеры их применения:
1.	Создание JSON-шаблонов:
•	Определите структуру данных: Прежде всего, определите, какие данные вы хотите передавать или получать. Разбейте их на логические блоки или объекты.
      •	Определите ключи и значения: Для каждого блока данных определите ключи и соответствующие значения. Ключи представляют собой названия атрибутов, а значения - сами данные.
      •	Следуйте синтаксису JSON: Убедитесь, что ваш JSON-шаблон соответствует синтаксису JSON. Он должен состоять из пар "ключ: значение", разделенных запятыми, и ограниченных фигурными скобками для объектов.
2.	Использование JSON-шаблонов:
      •	Прием данных: Для приема данных из внешних систем, IIoT-платформа считывает JSON-шаблон, а затем обрабатывает полученные данные в соответствии с вашей логикой (скриптом).
      •	Отправка данных: Для отправки данных во внешние системы, сначала сформируйте JSON-шаблон в соответствии с требованиями внешней системы, затем отправьте его через соответствующий канал связи.
3.	Примеры использования:
a) Пример JSON-шаблона для передачи данных о температуре и влажности с датчиков в IIoT-платформу:

{
"sensorData": {
"temperature": 25.5,
"humidity": 60
}
}
b) Пример JSON-шаблона для управления устройством через IIoT-платформу:
{
"deviceControl": {
"deviceId": "123456",
"command": "on"
}
}
c) Пример JSON-шаблона для получения данных о состоянии оборудования из IIoT-платформы:
{
"equipmentStatus": {
"pump1": "running",
"pump2": "stopped"
}
}
d) Пример JSON-шаблона для передачи данных о производственных параметрах:
{
"productionData": {
"machineId": "123",
"temperature": 180,
"pressure": 45,
"output": 500
}
}

e) Пример JSON-шаблона для управления режимами работы оборудования:
{
"equipmentControl": {
"deviceId": "789",
"mode": "manual",
"settings": {
"speed": 50,
"temperatureSetpoint": 200
}
}
}
f) Пример JSON-шаблона для передачи событий и аварий:
{
"alarmData": {
"alarmId": "ABC123",
"severity": "high",
"description": "Critical temperature threshold exceeded",
"timestamp": "2024-05-02T10:30:00"
}
}
g) Пример JSON-шаблона для запроса исторических данных:
{
"historicalDataRequest": {
"startDate": "2024-04-01",
"endDate": "2024-04-30",
"parameters": ["temperature", "pressure", "output"]
}
}
h) Пример JSON-шаблона для передачи информации о системных настройках:
{
"systemSettings": {
"samplingRate": 1000,
"language": "en",
"timezone": "UTC+3"
}
}
4. Использование различных структур данных в JSON-шаблонах.
   Синтаксис JSON-шаблонов для IIoT-платформ может быть таким же, как и для обычных JSON-данных. В качестве значений в JSON-шаблонах могут передаваться массивы и другие сложные типы данных.
   Примеры типов данных, которые могут быть использованы в JSON-шаблонах IIoT-платформ:
1.	Массивы (Arrays):

{
"sensorData": {
"temperatures": [25.5, 26.1, 24.8],
"humidities": [60, 62, 58]
}
}
2.	Объекты (Objects):

{
"sensorData": {
"location": {
"latitude": 40.7128,
"longitude": -74.0060
}
}
}
3.	Строки (Strings), Числа (Numbers), Логические значения (Boolean):

{
"equipmentStatus": {
"pump1": true,
"pump2": false,
"errorCode": "ERR123",
"message": "Pump overheating"
}
}
4.	Null-значения (Null):

{
"configuration": {
"timeout": null
}
}
5.	Вложенные структуры (Nested Structures):

{
"productionData": {
"line1": {
"output": 500,
"defects": ["Scratch", "Crack"]
},
"line2": {
"output": 600,
"defects": ["Chip"]
}
}
}
### Использование скриптов для обработки Json-шаблонов
1. Скрипт Erlang для обработки JSON-шаблонов:
   -module(json_handler).
   -export([process_json/1]).

% Функция для обработки JSON-шаблонов
process_json(JsonData) ->
% Парсим JSON
{ok, Json} = jsx:decode(JsonData),

	% Выполняем операции в зависимости от типа данных 
	case proplists:get_value(<<"sensorData">>, Json) of 
		undefined -> 
			io:format("Unknown JSON data: ~p~n", [Json]);
		 SensorData -> 
			% Обрабатываем данные о датчиках 
			process_sensor_data(SensorData) 
	end. 
% Функция для обработки данных о датчиках
process_sensor_data(SensorData) ->
Temperature = proplists:get_value(<<"temperature">>, SensorData),
Humidity = proplists:get_value(<<"humidity">>, SensorData),
io:format("Received sensor data - Temperature: ~p, Humidity: ~p~n", [Temperature, Humidity]).
2. Скрипт JavaScript для обработки JSON-шаблонов:
   // Функция для обработки JSON-шаблонов
   function processJson(jsonData) {
   // Разбираем ("парсим") JSON
   const json = JSON.parse(jsonData);

   // Выполняем операции в зависимости от типа данных
   if (json.sensorData) {
   // Обрабатываем данные о датчиках
   processSensorData(json.sensorData);
   } else {
   console.log("Unknown JSON data:", json);
   }
   }

// Функция для обработки данных о датчиках
function processSensorData(sensorData) {
const temperature = sensorData.temperature;
const humidity = sensorData.humidity;
console.log(`Received sensor data - Temperature: ${temperature}, Humidity: ${humidity}`);
}

### Настройка MQTT подключения
MQTT (Message Queuing Telemetry Transport) - это легковесный протокол передачи сообщений, специально разработанный для передачи данных в условиях ограниченной пропускной способности и надежности сети, таких как сенсорные сети и облачные вычисления.
Основное назначение MQTT - обеспечить эффективную и надежную передачу данных между клиентами и брокером сообщений (MQTT-сервером), который рассылает сообщения всем подписанным клиентам.
Протокол MQTT работает на основе принципа "издатель-подписчик", где клиенты могут публиковать сообщения в определенные темы, а другие клиенты могут подписываться на эти темы и получать опубликованные сообщения.
MQTT обеспечивает механизмы гарантированной доставки сообщений, управление качеством обслуживания (QoS), а также возможность работы в условиях ограниченной пропускной способности и ненадежных сетей.

При создании подключения типа IOT_MQTT появляется следующая форма:

![](IoT5.png){width=700 thumbnail="true"}{border-effect=line}

### Настройка WebSocket подключения
WebSocket - это протокол двусторонней связи поверх TCP, который позволяет устанавливать постоянное соединение между клиентом и сервером через веб-браузер или другое приложение.
Основное назначение WebSocket - обеспечить эффективную и низколатентную передачу данных в режиме реального времени. Он часто используется для создания интерактивных веб-приложений, онлайн-игр, чатов и стриминга мультимедийного контента.
Протокол WebSocket позволяет отправлять как текстовые, так и двоичные данные между клиентом и сервером, поддерживает одновременный обмен данными в обе стороны и обеспечивает механизмы контроля ошибок и переподключения.
При создании подключения типа IOT_WEBSOCKET_CLIENT появляется следующая форма:

![](IoT6.png){width=700 thumbnail="true"}{border-effect=line}

