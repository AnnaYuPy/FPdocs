# IoT-соединения

## Что такое IoT?
IoT расшифровывается как "Интернет вещей" (Internet of Things). Это концепция, в основе которой лежит идея о сети взаимосвязанных устройств, способных собирать и обмениваться данными через Интернет без прямого участия человека. Устройства IoT могут быть чем угодно: от умных домашних устройств, таких как термостаты и умные замки, до промышленного оборудования, автомобилей и даже медицинских приборов.

Основная идея IoT заключается в том, чтобы сделать устройства "умными", т.е. снабдить их сенсорами, актюаторами и возможностью подключения к интернету, что позволяет им собирать данные о своем окружении, взаимодействовать друг с другом и с внешними системами, а также выполнять различные задачи с минимальной или нулевой человеческой интервенцией.

IoT-соединения имеют ряд преимуществ и используются для:
1.	Расширения возможностей мониторинга и управления: Подключение IoT-устройств позволяет расширить область мониторинга и управления промышленными процессами. Данные, собранные с помощью IoT-устройств, могут дополнять информацию, собираемую традиционными средствами, обогащая ее и позволяя получать более полное представление о состоянии системы.
2.	Увеличения доступности данных: IoT-соединения могут обеспечить доступ к данным из удаленных местоположений, где установка традиционной инфраструктуры SCADA может быть сложной или дорогостоящей. Это позволяет мониторить и управлять процессами на расстоянии, что особенно важно для компаний с распределенными объектами.
3.	Улучшения гибкости и масштабируемости: Использование IoT-соединений позволяет создавать более гибкие и масштабируемые системы мониторинга и управления. Устройства IoT могут быть легко добавлены или удалены из сети, а сама сеть может быть масштабирована по мере необходимости, обеспечивая возможность адаптации к изменяющимся требованиям бизнеса.
4.	Использования современных технологий и аналитики: IoT-устройства могут предоставлять данные в реальном времени, что позволяет использовать современные технологии аналитики для обработки и анализа этих данных. Это может включать в себя применение методов машинного обучения для выявления аномалий или оптимизации процессов на основе собранных данных.
5.	Снижения затрат на обслуживание и эксплуатацию: Использование IoT-соединений может снизить затраты на обслуживание и эксплуатацию системы за счет возможности удаленного мониторинга и управления процессами. Это может включать в себя раннее обнаружение проблем и предотвращение аварийных ситуаций, что помогает сократить расходы на ремонт и замену оборудования.

## Настройка IoT-соединений в FACEPLATE

Для настройки IoT-соединения в FACEPLATE необходимо выбрать один из протоколов (HTTP, MQTT, WebSocket), согласно которому будет установлено подключение и будут передаваться данные.

Для настройки обмена данными по выбранному протоколу между FACEPLATE и другими информационными системами  используются следующие компоненты:
●	тип подключения (connection);
●	тип привязки (binding);
●	реакция (reaction) или направление передачи данных: источник данных (source) или действия (actions).

Структуру и общий принцип работы IoT-соединений в FACEPLATE можно представить следующим образом:

![](IoT1.png){width=700 thumbnail="true"}{border-effect=line}

Тип подключения позволяет установить базовые параметры соединения (название, протокол, период между попытками установки соединения и т.д.), включить или выключить соединение.

Соединение может включать в себя одну или несколько привязок. У привязки есть общие параметры, такие как название и тип привязки. Тип привязки определяет способ взаимодействия между системами:

1.  SEND - система только отправляет данные во внешнюю систему. Содержит только раздел Output.
2.	SEND_RECEIVE - система отправляет запрос во внешнюю система и ожидает, что внешняя система вернет какие-либо данные в ответ. Содержит раздел Output, за которым следует раздел Input.
3.	RECEIVE - система ожидает данные из внешней системы и не отправляет ничего в ответ. Содержит только раздел Input.
4.	RECEIVE_SEND - система ожидает данные из внешней системы и формирует ответ. Содержит раздел Input, за которым следует раздел Output.
      
Некоторые протоколы позволяют использовать все 4 типа привязок в одном соединении, другие позволяют использовать только определенные типы привязок в зависимости от настроек соединения.
В общем случае, в разделах Input/Output определяется json-шаблон, по которому будут формироваться данные для приема/передачи из/в удаленную систему. Так же в этом разделе может быть определен ряд параметров, используемых при передачи данных. Набор данных параметров зависит от протокола соединения.
Для первых двух типов привязок в разделе Output помимо json-шаблона и параметров, специфичных для протокола, так же определяется событие инициирующее обмен данными (см. рисунок 5.).

Настройка IoT-соединения выполняется во вкладке "Общий вид", расположенной в меню навигации  FACEPLATE Studio. На панели управления следует нажать на кнопку Создать, после чего появится окно:

![](IoT2.png){width=700 thumbnail="true"}{border-effect=line}

## Настройка HTTP-подключения {id="HTTP-connection"}

Подключения данного типа позволяют FACEPLATE обмениваться данными с удаленными системами посредством протокола HTTP. Задача, которая традиционно решается с помощью протокола HTTP - обмен данными между пользовательским приложением (например, веб-браузер), осуществляющим доступ к веб-ресурсам (веб-сервер).

•	HTTP (Hypertext Transfer Protocol) - это протокол, который используется для передачи данных в форме гипертекстовых документов (например, веб-страниц) между клиентом и сервером в сети Интернет.
•	HTTP предполагает однонаправленную связь, где клиент отправляет запрос на сервер, а сервер отвечает на этот запрос, обычно отправляя запрошенные данные.
•	Каждое HTTP-сообщение состоит из запроса и ответа. Запрос отправляется клиентом на сервер, и сервер отвечает на этот запрос соответствующим ответом.
•	HTTP не сохраняет состояние между запросами. Каждый запрос рассматривается отдельно, и сервер не запоминает предыдущие запросы от одного и того же клиента, если не используются механизмы сеансов или куки.
•	HTTP-запросы и ответы обычно представлены в виде текстовых сообщений, состоящих из заголовков и тела сообщения.
•	HTTP поддерживает различные методы запроса, такие как GET (получить), POST (отправить), PUT (обновить), DELETE (удалить) и другие, которые определяют действие, выполняемое сервером.

### Настройка привязки клиентского HTTP-соединения {id="HTTP-client"}

При создании подключения типа IOT_HTTP_CLIENT появляется следующая форма:

![](IoT3.png){width=700 thumbnail="true"}{border-effect=line}

После выбора HTTP соединения поменять его невозможно.

Для клиентского соединения дополнительно определяется host, с которым будет устанавливаться соединение. Также для клиентского соединения могут быть установлены дополнительные настройки безопасности, путем указания файлов сертификата, ключа и корневого сертификата.
Для серверного соединения может быть активирована опция "Аутентификация по сертификату". После активации этой опции появится возможность выбора сертификата, с которым будет сверятся сертификат, полученный в клиентском запросе. В данном случае, аутентификация будет происходить в два этапа.
На первом этапе сервер проверит, является ли полученный от клиента сертификат доверенным (соответствует ли издатель клиентского сертификата издателю сертификата сервера, сертификат сервера указывается в настройках системы). При этом Common Name (CN) у пользовательского сертификата не должно совпадать с CN серверного сертификата.

Если на этом этапе возникают ошибки при попытке соединения с сервером, для тестирования соединения можно воспользоваться утилитой командной строки curl:

curl -k -vvvv --cert файл_сертификата.cert.pem --key файл_ключа.key.pem --cacert файл_корневого_сертификата.cert.pem "https://путь к сервису".

Если первый этап пройден, на втором этапе клиентский сертификат сверяется с сертификатом, указанным в поле выбора сертификата настроек HTTP соединения. Если сертификат в клиентском запросе отсутствует или не соответствует заданному, считается, что клиент не прошел процедуру аутентификации.

### Настройка привязки серверного HTTP соединения {id="HTTP-server"}

Если был выбран тип HTTP соединения Server, то привязка может быть типа RECEIVE-ONLY или типа RECEIVE-SEND. Настройка привязки серверного HTTP соединения выполняется в следующей форме:

Непосредственно к HTTP протоколу относятся следующие поля:

1) Путь к настраиваемому сервису (path). Пример полного пути к сервису, настраиваемого в сторонней системе:
   
localhost:9000/rest/<connection name>/<binding name>?town=London&appid=4459999++ localhost:9000/rest - имя хоста, порт на котором запущен faceplate,  rest - префикс для всех rest запросов
http_server_connection_name - имя соединения
http_server_binding_name - имя привязки
http_path - дополнительный путь, настраивается в поле "путь" (path) привязки.
town=London & appid=4459999 - строка запроса

2) Метод запроса - GET или POST.

3) Заголовки HTTP - настройки заголовков HTTP. Каждый входящий запрос проверяется на соответствие заголовка установленному шаблону.

4) URL запрос - настройки параметров запроса. Каждый входящий запрос проверяется на соответствие параметров запроса установленным шаблонам.
   
### Настройка привязки клиентского HTTP соединения
   Если был выбран тип HTTP соединения Client, то привязка может быть типа SEND-ONLY или типа SEND-RECEIVE. Настройка привязки клиентского HTTP соединения выполняется в следующей форме:

Непосредственно к HTTP протоколу относятся следующие поля:

1) Путь (path) - составляющая полного URI запроса, не включающая host (из настроек http соединения) и параметры запроса.
2) Метод запроса - GET или POST.
3) HTTP заголовки - настройки заголовков HTTP. Можно добавить несколько заголовков HTTP. Слева - заголовок, справа - значение заголовка. Значением заголовка может быть текстовое значение либо строка-шаблон, содержащая переменные. Переменные задаются в формате ${имя_переменной}. Переменные позволяют формировать заголовки динамически.
4) URL запрос - настройки параметров запроса. Можно добавить несколько параметров. Слева - заголовок, справа - значение параметра. Значением параметра может быть текстовое значение либо строка-шаблон, содержащая переменные. Переменные позволяют формировать динамические GET-запросы.



При создании подключения типа IOT_HTTP_SERVER появляется следующая форма:

![](IoT4.png){width=700 thumbnail="true"}{border-effect=line}

2. Настройка MQTT подключения
   •	MQTT (Message Queuing Telemetry Transport) - это легковесный протокол передачи сообщений, специально разработанный для передачи данных в условиях ограниченной пропускной способности и надежности сети, таких как сенсорные сети и облачные вычисления.
   •	Основное назначение MQTT - обеспечить эффективную и надежную передачу данных между клиентами и брокером сообщений (MQTT-сервером), который рассылает сообщения всем подписанным клиентам.
   •	Протокол MQTT работает на основе принципа "издатель-подписчик", где клиенты могут публиковать сообщения в определенные темы, а другие клиенты могут подписываться на эти темы и получать опубликованные сообщения.
   •	MQTT обеспечивает механизмы гарантированной доставки сообщений, управление качеством обслуживания (QoS), а также возможность работы в условиях ограниченной пропускной способности и ненадежных сетей.

При создании подключения типа IOT_MQTT

![](IoT5.png){width=700 thumbnail="true"}{border-effect=line}

3. Настройка WebSocket подключения
   •	WebSocket - это протокол двусторонней связи поверх TCP, который позволяет устанавливать постоянное соединение между клиентом и сервером через веб-браузер или другое приложение.
   •	Основное назначение WebSocket - обеспечить эффективную и низколатентную передачу данных в режиме реального времени. Он часто используется для создания интерактивных веб-приложений, онлайн-игр, чатов и стриминга мультимедийного контента.
   Протокол WebSocket позволяет отправлять как текстовые, так и двоичные данные между клиентом и сервером, поддерживает одновременный обмен данными в обе стороны и обеспечивает механизмы контроля ошибок и переподключения.
   При создании подключения типа IOT_WEBSOCKET_CLIENT

![](IoT6.png){width=700 thumbnail="true"}{border-effect=line}

