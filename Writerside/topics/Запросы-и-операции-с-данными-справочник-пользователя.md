# Запросы и операции с данными: справочник пользователя

Структура запроса
Запросы в вашей системе имеют следующую структуру:

php
Копировать код
get <fields> from <databases> where <condition> [group by <fields>] [order by <fields> [ASC|DESC]] [page <offset>:<limit>] [lock <mode>] [format <formatter>]
get <fields>: Поля, которые нужно извлечь. Может включать несколько полей, разделенных запятыми.
from <databases>: Источники данных. Может включать несколько баз данных или таблиц, разделенных запятыми.
where <condition>: Условия фильтрации данных. Поддерживаются логические операторы AND, OR и ANDNOT.
group by <fields>: Группировка результатов по указанным полям.
order by <fields> [ASC|DESC]: Сортировка результатов по указанным полям, с указанием направления (по умолчанию ASC).
page <offset>:<limit>: Пагинация результатов, с указанием смещения и лимита.
lock <mode>: Указание режима блокировки (read или write).
format <formatter>: Указание форматтера для обработки данных.
Примеры запросов
Простой запрос с одним полем и простым условием:

sql
Копировать код
get foo from root where AND (bar := 1)
Пояснение: Извлечение поля foo из базы данных root, где поле bar равно 1.

Запрос с несколькими полями и условием с логическим оператором:

sql
Копировать код
get foo1, foo2 from db1,db2 where OR (buz :LIKE 'f', bar = -42)
Пояснение: Извлечение полей foo1 и foo2 из баз данных db1 и db2, где buz содержит символ f или bar равно -42.

Запрос с группировкой и сортировкой:

sql
Копировать код
get foo1 from d1,d2,'D3' where AND (bar :< 4) group by foo2, buz2 order by foo3, buz3 DESC
Пояснение: Извлечение поля foo1 из баз данных d1, d2 и D3, где bar меньше 4, с группировкой по полям foo2 и buz2 и сортировкой по полям foo3 (по возрастанию) и buz3 (по убыванию).

Запрос с пагинацией:

sql
Копировать код
get foo from root where AND (buz := 1) page 5:10
Пояснение: Извлечение поля foo из базы данных root, где buz равно 1, с ограничением результатов до 10 записей, начиная с 5-й записи.

Запрос с блокировкой:

sql
Копировать код
get foo from * where AND (bar :< 4) page 5:10 lock read
Пояснение: Извлечение поля foo из всех баз данных, где bar меньше 4, с ограничением результатов до 10 записей, начиная с 5-й записи, и режимом блокировки чтения.

Запрос с использованием форматтера:

sql
Копировать код
get foo1 from root where AND (bar :< 4) format $json
Пояснение: Извлечение поля foo1 из базы данных root, где bar меньше 4, с использованием форматтера $json.

Запрос с функциями:

sql
Копировать код
get $count() AS 'alias' from root where AND (buz :> 123)
Пояснение: Извлечение количества записей из базы данных root, где buz больше 123, и присвоение результирующему значению псевдонима alias.

Запрос с функцией и пользовательским форматом:

sql
Копировать код
get foo1 from root where AND (bar :< 4) format $my_lib:my_fun
Пояснение: Извлечение поля foo1 из базы данных root, где bar меньше 4, с использованием пользовательского форматтера $my_lib:my_fun.

Пояснения параметров запроса
Поле (Field): Имя атрибута или столбца данных, который нужно извлечь.
База данных (Database): Источник данных, из которого извлекаются записи. Это может быть имя таблицы, базы данных или глобальный символ * для всех источников.
Условие (Condition): Логическое выражение, определяющее, какие записи должны быть извлечены. Поддерживает операторы сравнения (=, :<, :>, :LIKE, :=) и логические операторы (AND, OR, ANDNOT).
Группировка (Group by): Поля, по которым данные должны быть сгруппированы.
Сортировка (Order by): Поля, по которым данные должны быть отсортированы, с указанием направления сортировки (по умолчанию ASC).
Пагинация (Page): Смещение и лимит для пагинации результатов.
Блокировка (Lock): Режим блокировки данных (чтение или запись).
Форматтер (Formatter): Функция или модуль, используемый для форматирования результирующих данных.
Эти примеры и пояснения должны помочь пользователю составлять запросы, соответствующие их потребностям, и понимать, какие параметры и операторы доступны для использования.

Там есть еще парсинг Insert и Delete. Можно ли по ним сделать такой анализ?

ChatGPT
Конечно, можно сделать аналогичный анализ для запросов INSERT и DELETE. Ниже приведены примеры запросов и пояснения параметров.

Структура запросов
INSERT
lua
Копировать код
insert <fields> [format <formatter>]
insert <fields>: Поля и значения, которые нужно вставить. Может включать несколько пар "поле=значение", разделенных запятыми.
format <formatter>: Указание форматтера для обработки данных.
DELETE
sql
Копировать код
delete from <databases> where <condition> [lock <mode>]
delete from <databases>: Указание базы данных или таблицы, из которой нужно удалить записи.
where <condition>: Условия фильтрации данных. Поддерживаются логические операторы AND, OR и ANDNOT.
lock <mode>: Указание режима блокировки (read или write).
Примеры запросов
INSERT
Простой запрос на вставку:

sql
Копировать код
insert foo1=123, foo2=$term('buz')
Пояснение: Вставка значений 123 в поле foo1 и результата вызова функции $term('buz') в поле foo2.

Запрос на вставку с использованием форматтера:

sql
Копировать код
insert foo1=123, foo2=$term('buz') format $from_string
Пояснение: Вставка значений 123 в поле foo1 и результата вызова функции $term('buz') в поле foo2 с использованием форматтера $from_string.

DELETE
Простой запрос на удаление:

sql
Копировать код
delete from root where AND (bar :< 1) lock write
Пояснение: Удаление записей из базы данных root, где bar меньше 1, с блокировкой на запись.

Запрос на удаление с условием OR:

sql
Копировать код
delete from * where OR (bar :> 1.0) lock read
Пояснение: Удаление записей из всех баз данных, где bar больше 1.0, с блокировкой на чтение.

Запрос на удаление с логическим оператором ANDNOT:

sql
Копировать код
delete from db1,db2 where ANDNOT (bar :LIKE '1', buz := foo)
Пояснение: Удаление записей из баз данных db1 и db2, где bar содержит символ 1 и buz не равно foo.

Пояснения параметров запроса
Поле (Field): Имя атрибута или столбца данных, которое нужно вставить или удалить.
База данных (Database): Источник данных, из которого удаляются записи или куда вставляются новые. Это может быть имя таблицы, базы данных или глобальный символ * для всех источников.
Условие (Condition): Логическое выражение, определяющее, какие записи должны быть удалены. Поддерживает операторы сравнения (=, :<, :>, :LIKE, :=) и логические операторы (AND, OR, ANDNOT).
Блокировка (Lock): Режим блокировки данных (чтение или запись).
Форматтер (Formatter): Функция или модуль, используемый для форматирования вставляемых данных.
Примеры и пояснения
INSERT
sql
Копировать код
insert foo1=123, foo2=$term('buz')
Пояснение: Вставляет запись с полем foo1, равным 123, и полем foo2, значением которого является результат функции $term('buz').
sql
Копировать код
insert foo1=123, foo2=$term('buz') format $from_string
Пояснение: Вставляет запись с полем foo1, равным 123, и полем foo2, значением которого является результат функции $term('buz'), используя форматтер $from_string.
DELETE
sql
Копировать код
delete from root where AND (bar :< 1) lock write
Пояснение: Удаляет записи из базы данных root, где поле bar меньше 1, с блокировкой на запись.
sql
Копировать код
delete from * where OR (bar :> 1.0) lock read
Пояснение: Удаляет записи из всех баз данных, где поле bar больше 1.0, с блокировкой на чтение.
sql
Копировать код
delete from db1,db2 where ANDNOT (bar :LIKE '1', buz := foo)
Пояснение: Удаляет записи из баз данных db1 и db2, где поле bar содержит символ 1 и поле buz не равно foo.
Эти примеры и пояснения помогут пользователю лучше понять, как составлять запросы для вставки и удаления данных в вашей системе, а также какие параметры и операторы доступны для использования.

Там еще есть парсинг set и get_aggr. Это что?

ChatGPT
Запросы set и get_aggr представляют собой дополнительные операции, которые могут быть выполнены в вашей системе. Давайте разберем их и предложим примеры с пояснениями параметров.

Структура запросов
SET
Запрос set используется для обновления значений в базе данных.

php
Копировать код
set <fields> in <databases> where <condition> [lock <mode>] [format <formatter>]
set <fields>: Поля и значения, которые нужно обновить. Может включать несколько пар "поле=значение", разделенных запятыми.
in <databases>: Источники данных, в которых нужно обновить записи.
where <condition>: Условия фильтрации данных. Поддерживаются логические операторы AND, OR и ANDNOT.
lock <mode>: Указание режима блокировки (read или write).
format <formatter>: Указание форматтера для обработки данных.
GET_AGGR
Запрос get_aggr используется для выполнения агрегатных функций, таких как count, sum, max, min.

vbnet
Копировать код
get <aggregate_function> AS <alias> from <databases> where <condition>
get <aggregate_function> AS <alias>: Агрегатная функция и псевдоним для результата.
from <databases>: Источники данных, из которых нужно извлечь записи.
where <condition>: Условия фильтрации данных. Поддерживаются логические операторы AND, OR и ANDNOT.
Примеры запросов
SET
Простой запрос на обновление:

sql
Копировать код
set foo=$hello in root where AND (bar :< 1) lock write
Пояснение: Обновляет поле foo значением результата вызова функции $hello в базе данных root, где bar меньше 1, с блокировкой на запись.

Запрос на обновление с несколькими полями и блокировкой:

sql
Копировать код
set foo1=123, foo2=$term(['{test}',$buz]) in db1,db2 where AND (bar :LIKE '1')
Пояснение: Обновляет поле foo1 значением 123 и поле foo2 значением результата вызова функции $term(['{test}',$buz]) в базах данных db1 и db2, где bar содержит символ 1.

Запрос на обновление с форматтером:

sql
Копировать код
set foo=$hello in root where AND (bar :< 1) format $from_json
Пояснение: Обновляет поле foo значением результата вызова функции $hello в базе данных root, где bar меньше 1, с использованием форматтера $from_json.

GET_AGGR
Запрос на получение количества записей:

sql
Копировать код
get $count() AS 'alias' from root where AND (buz :> 123)
Пояснение: Возвращает количество записей из базы данных root, где buz больше 123, и присваивает результату псевдоним alias.

Запрос на получение суммы значений поля:

sql
Копировать код
get $sum($int_field) from root where AND (buz :> 123)
Пояснение: Возвращает сумму значений поля int_field из базы данных root, где buz больше 123.

Запрос на получение максимального значения поля:

sql
Копировать код
get $max($float_field) from root where AND (buz :> 123)
Пояснение: Возвращает максимальное значение поля float_field из базы данных root, где buz больше 123.

Запрос на получение минимального значения поля:

sql
Копировать код
get $min($float_field) from root where AND (buz :> 123)
Пояснение: Возвращает минимальное значение поля float_field из базы данных root, где buz больше 123.

Пояснения параметров запроса
SET
Поле (Field): Имя атрибута или столбца данных, которое нужно обновить.
Значение (Value): Новое значение для атрибута или столбца.
База данных (Database): Источник данных, в котором обновляются записи.
Условие (Condition): Логическое выражение, определяющее, какие записи должны быть обновлены. Поддерживает операторы сравнения (=, :<, :>, :LIKE, :=) и логические операторы (AND, OR, ANDNOT).
Блокировка (Lock): Режим блокировки данных (чтение или запись).
Форматтер (Formatter): Функция или модуль, используемый для форматирования обновляемых данных.
GET_AGGR
Агрегатная функция (Aggregate Function): Функция, выполняющая агрегатные операции (count, sum, max, min).
Псевдоним (Alias): Имя для результирующего значения агрегатной функции.
База данных (Database): Источник данных, из которого извлекаются записи.
Условие (Condition): Логическое выражение, определяющее, какие записи должны быть извлечены. Поддерживает операторы сравнения (=, :<, :>, :LIKE, :=) и логические операторы (AND, OR, ANDNOT).
Эти примеры и пояснения помогут пользователю лучше понять, как составлять запросы для обновления данных (SET) и выполнения агрегатных функций (GET_AGGR) в вашей системе, а также какие параметры и операторы доступны для использования.

Анализ функций query_get_format, datetime_search, set, и set_format
Эти функции демонстрируют использование запросов для выборки и обновления данных в базе данных с использованием различных условий и параметров.

Функция query_get_format
Эта функция показывает, как можно выполнять запросы с форматированием и агрегатными функциями.

Пример запроса без параметров:
erlang
Копировать код
{Header1,Rows1} = ecomet_query:get([root], Fields, {<<"string1">>, '=', <<"value1">>}, [{format, fun ecomet_types:to_string/2}]).
Пояснение:

[root]: Источник данных.
Fields: Список полей, включающий в себя алиасы и функции.
{<<"string1">>, '=', <<"value1">>}: Условие выборки.
[{format, fun ecomet_types:to_string/2}]: Параметр форматирования.
Пример агрегатного запроса:
erlang
Копировать код
{Header4,Rows4} = ecomet_query:get(
[root],
[<<"string2">>, <<"string3">> | AggregatedFields],
{<<"bool">>, '=', true},
[
{group, [<<"string3">>, <<"string2">>]},
{order, [{<<"sum1">>, 'DESC'}]}
]
).
Пояснение:

[<<"string2">>, <<"string3">> | AggregatedFields]: Список полей, включая агрегатные функции.
{<<"bool">>, '=', true}: Условие выборки.
[{group, [<<"string3">>, <<"string2">>]}, {order, [{<<"sum1">>, 'DESC'}]}]: Параметры группировки и сортировки.
Функция datetime_search
Эта функция демонстрирует использование запросов с условиями по времени.

erlang
Копировать код
{Header1, Rows1} = ecomet_query:get(
[root],
[<<".name">>, <<"datetime">>],
{<<"datetime">>, 'DATETIME', [From, To]}
).
Пояснение:

[<<".name">>, <<"datetime">>]: Список полей для выборки.
{<<"datetime">>, 'DATETIME', [From, To]}: Условие выборки по диапазону времени.
Функция set
Эта функция показывает, как можно выполнять запросы на обновление данных.

erlang
Копировать код
SetFields = #{
<<"atom">> => test_set_value,
<<"integer">> => {fun([V]) -> V+5 end, [<<"integer">>]}
},
Count = ecomet_query:set([root], SetFields, {<<"string1">>, '=', <<"value1">>}).
Пояснение:

SetFields: Поля и значения для обновления.
[root]: Источник данных.
{<<"string1">>, '=', <<"value1">>}: Условие выборки.
Функция set_format
Эта функция аналогична set, но включает использование форматирования.

erlang
Копировать код
SetFields = #{
<<"atom">> => <<"test_set_value">>,
<<"integer">> => {fun([V]) -> V+5 end, [<<"integer">>]}
},
Count = ecomet_query:set([root], SetFields, {<<"string1">>, '=', <<"value1">>}, [{format, fun ecomet_types:from_string/2}]).
Пояснение:

SetFields: Поля и значения для обновления.
[root]: Источник данных.
{<<"string1">>, '=', <<"value1">>}: Условие выборки.
[{format, fun ecomet_types:from_string/2}]: Параметр форматирования.
Пояснение параметров
Поля (Fields): Поля для выборки или обновления, могут включать функции и алиасы.
Условия (Conditions): Логические выражения для фильтрации данных.
Агрегатные функции (Aggregated Functions): Функции для агрегатных операций, таких как count, max, min, sum.
Группировка (Group By): Поля для группировки результатов.
Сортировка (Order By): Поля и направления сортировки.
Форматирование (Format): Функции форматирования данных.
Эти примеры и пояснения помогут пользователям лучше понять, как составлять и использовать запросы для выборки и обновления данных в вашей системе.