# Сервера

На вкладке “Сервера” располагается одноимённый редактор, который предназначен для мониторинга состояний [серверов](Глоссарий.md#server) (узлов) системы,
для их запуска/останова в режиме RUN-TIME, удаления, переключения мастера, просмотра сообщений о событиях на сервере, запуска команд ECOMET.

Панель редактора имеет следующий вид:

![](Servers.1.png){width=700 thumbnail="true"}{border-effect=line}

## Панель управления

В верхней части редактора расположена панель управления:

![](Servers.2.png){width=700 thumbnail="true"}{border-effect=line}

На панели управления серверами есть несколько элементов:

| Элемент                         | Описание                                                                                                                                                                                   |
|---------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| ![](Servers.2.1.png){width=70}  | Элемент отражает текущее состояние режима RUN-TIME. Имеет 2 значения RUN/STOP.                                                                                                             |
| ![](Servers.2.2.png){width=70}  | Кнопка запуска/останова проекта в режиме RUN-TIME. Может быть в 2-х состояниях STOP/RUN.                                                                                                   |
| ![](Servers.2.3.png){width=150} | Элемент, который отражает имя сервера, к которому на данный момент подключен браузер. Имеет следующий формат: fp@<имя хоста>. Имя хоста задается в процессе установки Faceplate на сервер. |
| ![](Servers.2.4.png){width=150} | Элемент отражает текущее время на сервере.                                                                                                                                                 |
| ![](Servers.2.5.png){width=200} | Кнопка позволяет назначить/переключить мастер-сервер. Надпись на кнопке отображает имя мастер-сервера в текущий момент.                                                                    |

## Мониторинг состояния серверов

Для каждого сконфигурированного сервера выводится информация о его текущем состоянии. Информация выводится в карточках серверов, которые обновляются каждые 5 секунд.

Карточка сервера выглядит следующим образом:

![](Servers.3.png){width=700 thumbnail="true"}{border-effect=line}

Каждая карточка состоит из 3-х областей:
* заголовок с именем и IP-адресом сервера,
* системная информация о сервере,
* консоль, отражающая события, происходящие на сервере, в хронологическом порядке (логи), и строки для ввода команд СУБД ECOMET.

| Элемент карточки                | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|---------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| ![](Servers.3.1.png){width=200} | Имя сервера и его IP-адрес. Если иконка (показывает статус узла) зеленого цвета ![](Servers.3.1.2.png){width=20}, значит сервер подключен, активен, вся необходимая информация скопирована, и сервер может принять роль мастера. В противном случае иконка ![](Servers.3.1.1.png){width=20}.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| ![](Servers.3.2.png){width=200} | Текущее время на сервере.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ![](Servers.3.3.png){width=200} | Объем занятой и доступной оперативной памяти.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| ![](Servers.3.4.png){width=200} | Процент использования ЦПУ. Для узлов работающих под управлением ОС Linux процент рассчитывается по формуле: Load_% = 100 * (1 - Factor / (Factor +Load_rup)), где Load_% - рассчитанный процент использования ЦПУ, Load_rup - среднее количество времени, проводимое процессами в очереди ожидания, Factor - корректирующий фактор. Время ожидания процессами своей очереди является косвенным показателем оценки нагрузки на ЦПУ. Для перевода этого параметра в % необходимо учитывать мощность и конфигурацию процессора. Это выполняется через подстройку корректирующего фактора. Более подробную информацию можно найти по ссылке [https://linux.die.net/man/3/cpu_sup](https://linux.die.net/man/3/cpu_sup). <br/>Для узлов работающих под управлением Windows корректирующий фактор не участвует в расчете нагрузки на ЦПУ. |
| ![](Servers.3.5.png){width=200} | Количество активных сессий на данном узле. Соответствует количеству подключений. Среда исполнения использует 2 постоянных подключения и по одному динамическому подключению на каждое формирование отчета. Это означает что при открытии в браузере среды исполнения на узле появляются 2 новые сессии, а во время формирования отчета появляется еще одна сессия. По щелчку на кнопке с количеством сессий открывается окно, содержащее информацию по открытым сессиям: <br>* пользователь под которым выполнено подключение; <br>* время открытия соединения; <br>* доп. информация по подключению.                                                                                                                                                                                                                               |
| ![](Servers.3.6.png){width=200} | ??????????????????????????????                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| ![](Servers.3.7.png){width=150} | Информация об установленной на сервере лицензии.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| ![](Servers.3.8.png){width=150} | Доменное имя сервера                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| ![](Servers.3.9.png){width=200} | Информация о директориях на сервере. По каждой директории отображается: <br>* Процент заполнения <br>* Объем занятого пространства <br>* Объем доступного пространства                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| ![](Servers.3.10.png){width=30} | Кнопка удаления сервера. Перед удалением сервер должен быть остановлен и отключен. На текущем сервере эта кнопка всегда неактивна.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |

На консоле можно просмотреть логи согласно фильтрам посиковой строки:
![](Servers.4.1.png){width=700 thumbnail="true"}{border-effect=line}
и запустить на выполнение команды для ECOMET:
![](Servers.4.2.png){width=700 thumbnail="true"}{border-effect=line}
где

| Элемент                         | Описание                                                                                              |
|---------------------------------|-------------------------------------------------------------------------------------------------------|
| ![](Servers.4.3.png){width=200} | Фильтр выбора даты, для которой нужно отразить записи о событиях на сервере.                          |
| ![](Servers.4.4.png){width=150} | Фильтр количества записей за выбранную дату????????????????                                           |
| ![](Servers.4.5.png){width=150} | Фильтр типа события, для которого нужно вывести сообщения.                                            |
| ![](Servers.4.6.png){width=70}  | Кнопка для отражения сообщений с выбранными фильтрами.                                                |
| ![](Servers.4.7.png){width=200} | Установка частоты обновлений: без обновлений, каждые 5, 10, 60 секунд или в режиме реального времени. |
| ![](Servers.4.8.png){width=30}  | Кнопка сброса фильтров в состояние по умолчанию.                                                      |
| ![](Servers.4.9.png){width=200} | Строка терминала для запуска команд в ECOMET.                                                         |

Внизу панели серверов находится список подключенных серверов, с возможностью просмотра их карточек:

![](Servers.4.10.png){width=700 thumbnail="true"}{border-effect=line}


## Добавление нового сервера

Для добавления к системе нового сервера нужно:
1.	Подготовить физический сервер, установив на нем Faceplate.
2.	Запустить приложение Faceplate на новом сервере. При первом запуске Faceplate на резервном сервере приложение ждет пока мастер-сервер подключится и скопирует на него необходимые данные.
3.	В редакторе серверов на действующем проекте щелкнуть по кнопке “Добавить” на панели управления и задать имя узла для добавляемого сервера. Имя узла имеет следующий формат: fp@<имя хоста>. Имя хоста должно совпадать с именем, определенным в процессе установки.

В результате появится карточка нового сервера и мастер-сервер начнет копирование необходимой информации на новый сервер. Когда копирование будет завершено иконка добавленного сервера станет зеленого цвета, это означает что сервер в работе и готов принять роль мастера.

> **ВНИМАНИЕ!**
>
> Все действия могут выполняться на рабочей системе, без необходимости останова RUN-TIME.
>
{style="note"}

## Возможные проблемы

Если при добавлении сервера к системе в его карточке флаг состояния connected остается false, необходимо убедиться, что
* доменное имя для нового сервера совпадает с именем хоста в имени узла сервера. Имя узла задается при установке Faceplate.
* новый сервер доступен с мастер-сервера. Для этого можно воспользоваться командой ping. При пинговании нужно использовать доменное имя (имя хоста).
* на новом сервере открыт порт 4369. Для этого можно воспользоваться утилитой telnet.

Если проблема не устранена нужно перезагрузить новый сервер и повторно запустить Faceplate.

## Назначение нового мастера
Сервер, выполняющий роль мастера, обеспечивает работу режима RUN-TIME. Мастер выполняет опрос контроллерного оборудования, обеспечивает ведение архивов и работу системы сообщений. Если для системы настроено горячее резервирование, то роль мастера могут принимать на себя сервера, находящиеся в режиме stand-by. Передача роли мастера между серверами выполняется при отказе сервера, выполняющего роль мастера, или при явном задании нового мастера в редакторе серверов.

Для передачи роли мастера другому серверу нужно щелкнуть по кнопке выбора мастера на панели управления:

![](Servers.2.5.png){width=150}

Будет выведен список серверов, готовых принять роль мастера.

Если ни один из серверов не готов принять роль мастера, будет выведено сообщение:

![](Servers.2.6.png)

## Запуск/Останов проекта в RUN-TIME

В режиме RUN-TIME на сервере, выполняющем роль мастера, работают процессы обеспечивающие опрос контроллерного оборудования, ведение архивов, работу системы сообщений и ряд других процессов, обеспечивающих управление объектом. При выходе из режима RUN-TIME перечисленные процессы завершаются и система перестает выполнять функции по управлению объектом - переходит в режим STOP. Среда разработки проекта функционирует независимо от состояния режима RUN-TIME.

Для запуска проекта в RUN-TIME нужно щелкнуть по кнопке “RUN” на панели управления:

![](Servers.2.7.png)

В результате будет на мастер-сервере будет выполнен запуск процессов, обеспечивающих управление объектом, после чего кнопка приобретет следующий вид:

Для выхода из режима RUN-TIME нужно щелкнуть по кнопке STOP.

![](Servers.2.8.png)

## Обеспечение надежной интеграции и оптимизация работы серверов
Для обеспечения надежного и эффективного функционирования системы можно использовать команду ATTACH_TO, для подключения одного сервера к другому. Это может быть полезно для:

- <b> резервного копирования и восстановления:</b> команда ATTACH_TO может использоваться для подключения резервного сервера к основному серверу, для периодического создания резервных копий данных одного сервера и их последующем восстановлении на другом сервере в случае сбоя или отказа первого сервера;

- <b> масштабирования и распределения нагрузки:</b> в больших Iot-платформах, таких как Faceplate, может потребоваться распределение нагрузки между несколькими серверами для обеспечения высокой производительности и отказоустойчивости. Команда ATTACH_TO может быть использована для присоединения дополнительных серверов к основному серверу и распределения части нагрузки между ними;

- <b> горячего резервирования серверов:</b> команда ATTACH_TO в SCADA-системе может использоваться как часть механизма горячего резервирования, позволяя быстро и эффективно переключаться с основного сервера на резервный сервер в случае необходимости;

- <b> географической репликации данных:</b> для обеспечения отказоустойчивости и защиты от потери данных в случае катастрофы или отказа оборудования может использоваться географическая репликация данных между серверами, находящимися в разных географических точках. Команда ATTACH_TO может быть использована для присоединения удаленного сервера к локальному серверу и синхронизации данных между ними;

- <b> автоматического обновления конфигурации и программного обеспечения:</b> команда ATTACH_TO может быть использована для автоматического обновления конфигурации и программного обеспечения на сервере, например, при развертывании новой версии IoT-платформы или ее компонентов. Это позволяет обновлять серверы без простоя системы и минимизировать риск возникновения ошибок при ручном обновлении.

<b>Пример 1. </b> Настройка для прикрепления (ATTACH_TO) одного сервера к другому:

1.	Дать имена серверам. Допустим, мы назовем их "master.fp" и "slave.fp".
2.	Указать адреса серверов для каждой из них. Для этого нужно выполнить команду:
```bash
      nano /etc/hosts
```
Например, адреса могут быть следующие:
```bash
192.168.1.78 master.fp
192.168.1.92 slave.fp
```
3.	Далее нужно запустить мастер-сервер через терминал командой:
```bash
      ./test_shell
```
4.	А также запустить слэйв-сервер командой:
```bash
      env ATTACH_TO=fp@master.fp ./test_shell
```
Это завершит настройку. Для настройки резервирования необходимо проделать то же самое, а также:

5. В редакторе базы данных добавить запись для слэйв-сервера.

   ![](Servers.5.png){width=700 thumbnail="true"}{border-effect=line}

## Настройка горячего резервирования

Повышение отказоустойчивости системы может достигаться за счет обеспечения горячего резервирования серверов. В режиме горячего резервирования имеется один мастер, остальные сервера работают в режиме stand-by. Мастер выполняет опрос контроллерного оборудования, обеспечивает ведение архивов и работу системы сообщений. Сервера, находящиеся в режиме stand-by, также как и мастер могут использоваться для подключения из среды разработки или среды исполнения. При выходе по какой-либо причине из строя мастер-сервера (отказ оборудования, перебои в электроснабжении и т. д.), первый стоящий в режиме standby сервер диагностирует сбой мастер-сервера и берет нагрузку на себя: устанавливает подключения к контроллерному оборудованию, запускает процессы системы архивирования и системы сообщений. Клиентские подключения автоматически переключаются на доступный сервер. При восстановлении сервера не происходит автоматического возврата ему роли мастера. При необходимости можно сделать это явно.

Для обеспечения горячего резервирования система должна состоять минимум из 2 серверов. Физические сервера должны находиться в одной локальной сети и на каждом сервере должен быть открыт доступ к порту 4369. В режиме горячего резервирования между серверами передается большое количество информации (пропорционально масштабу проекта), поэтому канал связи между серверами должен иметь высокую пропускную способность (минимум 100 мбит/сек.).
