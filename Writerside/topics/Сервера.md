# Сервера

На вкладке “Сервера” располагается одноимённый редактор, который предназначен для мониторинга состояний [серверов](Глоссарий.md#server) (узлов) системы,
для их запуска/останова в режиме RUN-TIME, удаления, переключения мастера, просмотра сообщений о событиях на сервере, запуска команд ECOMET.

Панель редактора имеет следующий вид:

![](Servers.1.png){width=700 thumbnail="true"}{border-effect=line}

## Панель управления

В верхней части редактора расположена панель управления:

![](Servers.2.png){width=700 thumbnail="true"}{border-effect=line}

На панели управления серверами есть несколько элементов:

| Элемент                         | Описание                                                                                                                                                                                   |
|---------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| ![](Servers.2.1.png){width=70}  | Элемент отражает текущее состояние режима RUN-TIME. Имеет 2 значения RUN/STOP.                                                                                                             |
| ![](Servers.2.2.png){width=70}  | Кнопка запуска/останова проекта в режиме RUN-TIME. Может быть в 2-х состояниях STOP/RUN.                                                                                                   |
| ![](Servers.2.3.png){width=150} | Элемент, который отражает имя сервера, к которому на данный момент подключен браузер. Имеет следующий формат: fp@<имя хоста>. Имя хоста задается в процессе установки Faceplate на сервер. |
| ![](Servers.2.4.png){width=150} | Элемент отражает текущее время на сервере.                                                                                                                                                 |
| ![](Servers.2.5.png){width=200} | Кнопка позволяет назначить/переключить мастер-сервер. Надпись на кнопке отображает имя мастер-сервера в текущий момент.                                                                    |

## Мониторинг состояния серверов

Для каждого сконфигурированного сервера выводится информация о его текущем состоянии. Информация выводится в карточках серверов, которые обновляются каждые 5 секунд.

Карточка сервера выглядит следующим образом:

![](Servers.3.png){width=700 thumbnail="true"}{border-effect=line}

Каждая карточка состоит из 3-х областей:
* заголовок с именем и IP-адресом сервера,
* системная информация о сервере,
* консоль, отражающая события, происходящие на сервере, в хронологическом порядке (логи), и строки для ввода команд СУБД ECOMET.

| Элемент карточки                | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|---------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| ![](Servers.3.1.png){width=200} | Имя сервера и его IP-адрес. Если иконка (показывает статус узла) зеленого цвета ![](Servers.3.1.2.png){width=20}, значит сервер подключен, активен, вся необходимая информация скопирована, и сервер может принять роль мастера. В противном случае иконка ![](Servers.3.1.1.png){width=20}.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| ![](Servers.3.2.png){width=200} | Текущее время на сервере.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ![](Servers.3.3.png){width=200} | Объем занятой и доступной оперативной памяти.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| ![](Servers.3.4.png){width=200} | Процент использования ЦПУ. Для узлов работающих под управлением ОС Linux процент рассчитывается по формуле: Load_% = 100 * (1 - Factor / (Factor +Load_rup)), где Load_% - рассчитанный процент использования ЦПУ, Load_rup - среднее количество времени, проводимое процессами в очереди ожидания, Factor - корректирующий фактор. Время ожидания процессами своей очереди является косвенным показателем оценки нагрузки на ЦПУ. Для перевода этого параметра в % необходимо учитывать мощность и конфигурацию процессора. Это выполняется через подстройку корректирующего фактора. Более подробную информацию можно найти по ссылке [https://linux.die.net/man/3/cpu_sup](https://linux.die.net/man/3/cpu_sup). <br/>Для узлов работающих под управлением Windows корректирующий фактор не участвует в расчете нагрузки на ЦПУ. |
| ![](Servers.3.5.png){width=200} | Количество активных сессий на данном узле. Соответствует количеству подключений. Среда исполнения использует 2 постоянных подключения и по одному динамическому подключению на каждое формирование отчета. Это означает что при открытии в браузере среды исполнения на узле появляются 2 новые сессии, а во время формирования отчета появляется еще одна сессия. По щелчку на кнопке с количеством сессий открывается окно, содержащее информацию по открытым сессиям: <br>* пользователь под которым выполнено подключение; <br>* время открытия соединения; <br>* доп. информация по подключению.                                                                                                                                                                                                                               |
| ![](Servers.3.6.png){width=200} | ??????????????????????????????                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| ![](Servers.3.7.png){width=150} | Информация об установленной на сервере лицензии.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| ![](Servers.3.8.png){width=150} | Доменное имя сервера                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| ![](Servers.3.9.png){width=200} | Информация о директориях на сервере. По каждой директории отображается: <br>* Процент заполнения <br>* Объем занятого пространства <br>* Объем доступного пространства                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| ![](Servers.3.10.png){width=30} | Кнопка удаления сервера. Перед удалением сервер должен быть остановлен и отключен. На текущем сервере эта кнопка всегда неактивна.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |

На консоле можно просмотреть логи согласно фильтрам посиковой строки:
![](Servers.4.1.png){width=700 thumbnail="true"}{border-effect=line}
и запустить на выполнение команды для ECOMET:
![](Servers.4.2.png){width=700 thumbnail="true"}{border-effect=line}
где

| Элемент                         | Описание                                                                                              |
|---------------------------------|-------------------------------------------------------------------------------------------------------|
| ![](Servers.4.3.png){width=200} | Фильтр выбора даты, для которой нужно отразить записи о событиях на сервере.                          |
| ![](Servers.4.4.png){width=150} | Фильтр количества записей за выбранную дату????????????????                                           |
| ![](Servers.4.5.png){width=150} | Фильтр типа события, для которого нужно вывести сообщения.                                            |
| ![](Servers.4.6.png){width=70}  | Кнопка для отражения сообщений с выбранными фильтрами.                                                |
| ![](Servers.4.7.png){width=200} | Установка частоты обновлений: без обновлений, каждые 5, 10, 60 секунд или в режиме реального времени. |
| ![](Servers.4.8.png){width=30}  | Кнопка сброса фильтров в состояние по умолчанию.                                                      |
| ![](Servers.4.9.png){width=200} | Строка терминала для запуска команд в ECOMET.                                                         |

Внизу панели серверов находится список подключенных серверов, с возможностью просмотра их карточек:

![](Servers.4.10.png){width=700 thumbnail="true"}{border-effect=line}


## Добавление нового сервера

Для добавления к системе нового сервера нужно:
1.	Подготовить физический сервер, установив на нем Faceplate.
2.	Запустить приложение Faceplate на новом сервере. При первом запуске Faceplate на резервном сервере приложение ждет пока мастер-сервер подключится и скопирует на него необходимые данные.
3.	В редакторе серверов на действующем проекте щелкнуть по кнопке “Добавить” на панели управления и задать имя узла для добавляемого сервера. Имя узла имеет следующий формат: fp@<имя хоста>. Имя хоста должно совпадать с именем, определенным в процессе установки.

В результате появится карточка нового сервера и мастер-сервер начнет копирование необходимой информации на новый сервер. Когда копирование будет завершено иконка добавленного сервера станет зеленого цвета, это означает что сервер в работе и готов принять роль мастера.

> **ВНИМАНИЕ!**
>
> Все действия могут выполняться на рабочей системе, без необходимости останова RUN-TIME.
>
{style="note"}

## Возможные проблемы

Если при добавлении сервера к системе в его карточке флаг состояния connected остается false, необходимо убедиться, что
* доменное имя для нового сервера совпадает с именем хоста в имени узла сервера. Имя узла задается при установке Faceplate.
* новый сервер доступен с мастер-сервера. Для этого можно воспользоваться командой ping. При пинговании нужно использовать доменное имя (имя хоста).
* на новом сервере открыт порт 4369. Для этого можно воспользоваться утилитой telnet.

Если проблема не устранена нужно перезагрузить новый сервер и повторно запустить Faceplate.

## Назначение нового мастера
Сервер, выполняющий роль мастера, обеспечивает работу режима RUN-TIME. Мастер выполняет опрос контроллерного оборудования, обеспечивает ведение архивов и работу системы сообщений. Если для системы настроено горячее резервирование, то роль мастера могут принимать на себя сервера, находящиеся в режиме stand-by. Передача роли мастера между серверами выполняется при отказе сервера, выполняющего роль мастера, или при явном задании нового мастера в редакторе серверов.

Для передачи роли мастера другому серверу нужно щелкнуть по кнопке выбора мастера на панели управления:

![](Servers.2.5.png){width=150}

Будет выведен список серверов, готовых принять роль мастера.

Если ни один из серверов не готов принять роль мастера, будет выведено сообщение:

![](Servers.2.6.png)

## Запуск/Останов проекта в RUN-TIME

В режиме RUN-TIME на сервере, выполняющем роль мастера, работают процессы обеспечивающие опрос контроллерного оборудования, ведение архивов, работу системы сообщений и ряд других процессов, обеспечивающих управление объектом. При выходе из режима RUN-TIME перечисленные процессы завершаются и система перестает выполнять функции по управлению объектом - переходит в режим STOP. Среда разработки проекта функционирует независимо от состояния режима RUN-TIME.

Для запуска проекта в RUN-TIME нужно щелкнуть по кнопке “RUN” на панели управления:

![](Servers.2.7.png)

В результате будет на мастер-сервере будет выполнен запуск процессов, обеспечивающих управление объектом, после чего кнопка приобретет следующий вид:

Для выхода из режима RUN-TIME нужно щелкнуть по кнопке STOP.

![](Servers.2.8.png)

## Обеспечение надежной интеграции и оптимизация работы серверов
Для обеспечения надежного и эффективного функционирования системы можно использовать переменную окружения ATTACH_TO, которая используется для управления процессом подключения виртуальной машины Erlang (VM) одного сервера к виртуальной машине другого. Это может быть полезно для:

- <b> резервного копирования и восстановления:</b> переменная окружения ATTACH_TO может использоваться для подключения резервного сервера к основному серверу, для периодического создания резервных копий данных одного сервера и их последующем восстановлении на другом сервере в случае сбоя или отказа первого сервера;

- <b> масштабирования и распределения нагрузки:</b> в больших Iot-платформах, таких как Faceplate, может потребоваться распределение нагрузки между несколькими серверами для обеспечения высокой производительности и отказоустойчивости. Переменная окружения ATTACH_TO может быть использована для присоединения дополнительных серверов к основному серверу и распределения части нагрузки между ними;

- <b> горячего резервирования серверов:</b> переменная окружения ATTACH_TO в IoT-платформе может использоваться как часть механизма горячего резервирования, позволяя быстро и эффективно переключаться с основного сервера на резервный сервер в случае необходимости;

- <b> географической репликации данных:</b> для обеспечения отказоустойчивости и защиты от потери данных в случае катастрофы или отказа оборудования может использоваться географическая репликация данных между серверами, находящимися в разных географических точках. Переменная окружения ATTACH_TO может быть использована для присоединения удаленного сервера к локальному серверу и синхронизации данных между ними;

- <b> автоматического обновления конфигурации и программного обеспечения:</b> переменная окружения ATTACH_TO может быть использована для автоматического обновления конфигурации и программного обеспечения на сервере, например, при развертывании новой версии IoT-платформы или ее компонентов. Это позволяет обновлять серверы без простоя системы и минимизировать риск возникновения ошибок при ручном обновлении.

<b>Пример 1. </b> Настройка для прикрепления (ATTACH_TO) одного сервера к другому:

1.	Дать имена серверам. Допустим, мы назовем их "master.fp" и "slave.fp".
2.	Указать адреса серверов для каждой из них. Для этого нужно выполнить команду:
```bash
      nano /etc/hosts
```
Например, адреса могут быть следующие:
```bash
192.168.1.78 master.fp
192.168.1.92 slave.fp
```
3.	Далее нужно запустить мастер-сервер через терминал виртуальной машины Erlang командой:
```bash
      ./test_shell
```
4.	А также запустить слэйв-сервер командой, где в переменной окружения указано имя сервера, к которому прикрепляется вновь запущенный:
```bash
      env ATTACH_TO=fp@master.fp ./test_shell
```
Это завершит настройку. Для настройки резервирования необходимо проделать то же самое, а также:

5. В редакторе базы данных добавить запись для слэйв-сервера.

   ![](Servers.5.png){width=700 thumbnail="true"}{border-effect=line}

## Резервирование в Faceplate

В Faceplate вместо традиционного горячего резервирования, где один сервер ожидает сбоя основного, была реализована распределенная отказоустойчивая система. Здесь все сервера активно участвуют в процессе, с мастер-сервером, который координирует их деятельность. Каждый сервер выполняет определенные задачи и хранит часть базы данных.

В случае сбоя одного из серверов, наименее загруженный сервер берет на себя его функции. Это позволяет системе оставаться доступной даже при отказе отдельных компонентов. Однако, в угоду доступности может быть нарушена согласованность данных (consistency), так как не все сервера будут обновлены одновременно, и часть данных может оказаться устаревшей на некоторое время или даже потерянной.

Эту архитектуру можно понять, если вспомнить основные принципы CAP-теоремы из теории информации:

- <b>Availability (Доступность):</b> Этот принцип подчеркивает важность того, чтобы система была доступна для пользователей в любое время, даже при наличии сбоев. В случае распределенной отказоустойчивой системы, все серверы активно участвуют и могут взять на себя функции упавшего сервера, обеспечивая бесперебойную работу системы.

- <b>Consistency (Согласованность):</b> Этот принцип означает, что данные в системе должны быть согласованными и корректными в любой момент времени. Однако, в распределенных системах, где акцент делается на доступность, могут возникать временные различия в данных между серверами из-за асинхронной синхронизации или задержек в обновлении.

- <b>Partition tolerance (Устойчивость к разделению):</b> Этот принцип указывает на способность системы функционировать даже в случае разделения на части или сетевых сбоев между компонентами. В распределенной отказоустойчивой системе, разделенные серверы могут продолжать работать независимо друг от друга, что обеспечивает высокую устойчивость к разделению.

В Faceplate предпочтение отдается доступности (availability) в ущерб согласованности (consistency). Это означает, что система стремится оставаться доступной для пользователей даже при возникновении сбоев, но при этом может временно допускать несогласованность данных между серверами.

Такой подход важен для критических систем, где непрерывная доступность играет решающую роль, например, в системах управления промышленным оборудованием или энергетическими сетями. Обычно в таких системах быстрый отклик и минимизация простоев критически важны.

Можно рассмотреть несколько примеров использования распределенных отказоустойчивых систем:

<b>Пример 1.</b> Представим себе распределенную систему управления энергетическими сетями, где различные подстанции оборудованы серверами для мониторинга и управления работой. Каждый сервер отвечает за сбор данных о производстве и потреблении энергии, а также за принятие решений о распределении нагрузки и обеспечении стабильности сети.

Если одна из подстанций перестает отвечать из-за сбоя или перегрузки, другие серверы могут автоматически принять на себя ее функции, чтобы обеспечить непрерывную работу энергетической сети. Например, серверы могут динамически перераспределять нагрузку между собой, чтобы компенсировать отказавший сервер и обеспечить стабильное энергоснабжение.

Однако, во время переходного периода, когда один сервер перестает работать, возможно некоторое несоответствие в данных о текущем состоянии энергетической сети между различными серверами. Это может привести к временным несогласованностям в информации о производстве и потреблении энергии, а также о статусе оборудования и состоянии сети.

Тем не менее, важно, чтобы энергетическая сеть оставалась доступной и способной обеспечивать энергоснабжение даже в условиях сбоев или нагрузки. Поэтому в таких ситуациях отдается приоритет доступности данных в ущерб полной согласованности между серверами.

<b>Пример 2. </b> Рассмотрим медицинскую информационную систему, в которой различные серверы хранят данные о медицинской истории пациентов, результаты анализов, назначения врачей и другую важную информацию. Когда один из серверов становится недоступным из-за сбоя или перегрузки, другие серверы автоматически принимают на себя его функции, чтобы обеспечить доступность информации для медицинского персонала и обеспечить непрерывное оказание медицинских услуг.

Во время такого переходного периода может возникнуть некоторое несоответствие в данных между различными серверами. Например, информация о последних анализах или назначениях может быть обновлена на одном сервере, но еще не синхронизирована с другими серверами. Это может привести к временным несогласованностям в медицинской информации и небольшим задержкам в доступе к обновленным данным.

Однако, важно, чтобы медицинские информационные системы оставались доступными и способными предоставлять информацию о пациентах даже в условиях сбоев или перегрузки. Поэтому в таких ситуациях отдается приоритет доступности данных в ущерб полной согласованности между серверами. Это позволяет медицинскому персоналу продолжать обслуживать пациентов и принимать необходимые медицинские решения, несмотря на временные различия в информации между серверами.

<b>Пример 3.</b> Проанализируем финансовую торговую платформу, на которой размещены серверы для обработки и выполнения торговых операций, мониторинга цен и обновления информации о финансовых инструментах. Когда один из серверов становится недоступным из-за сбоя или перегрузки, другие серверы автоматически принимают на себя его функции, чтобы обеспечить доступность для трейдеров и непрерывное проведение торгов.

В переходный период возможно некоторое несоответствие в данных между различными серверами. Например, информация о текущих ценах или статусе торговых заявок может быть обновлена на одном сервере, но еще не синхронизирована с другими серверами. Это может привести к временным несогласованностям в информации о рынке и небольшим задержкам в выполнении торговых операций.
Однако, важно, чтобы финансовая торговая платформа оставалась доступной и способной проводить торговые операции даже в условиях сбоев или перегрузки. Поэтому в таких ситуациях отдается приоритет доступности данных в ущерб полной согласованности между серверами. Это позволяет трейдерам продолжать торговлю и реагировать на изменения на рынке, несмотря на временные различия в информации между серверами.
